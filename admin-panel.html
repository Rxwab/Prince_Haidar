<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم النشر السري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #2c2c2c;
            color: #f7f7f7;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .accent-color {
            color: #d4a761; /* اللون الذهبي */
        }
        .btn-gold {
            background-color: #d4a761;
            color: #3b2820;
            transition: background-color 0.3s ease;
        }
        .btn-gold:hover {
            background-color: #bfa05d;
        }
        .dark-bg-input {
            background-color: #3b2820; /* اللون البني الداكن */
        }
    </style>
</head>
<body>
    
    <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-xl transform transition-all duration-300 scale-100">
        
        <h1 class="text-4xl font-bold text-red-500 mb-8 text-center border-b border-gray-700 pb-3">
            لوحة تحكم النشر (Admin Panel)
        </h1>
        
        <p class="text-sm text-yellow-400 mb-6 text-center">
            تأكد من وضع رابط الصورة والرمز السري جاهز للنشر.
        </p>

        <div class="mb-4">
            <label for="image-url" class="block text-white text-lg mb-2">رابط الصورة الجديدة (URL):</label>
            <input type="url" id="image-url" placeholder="https://i.ibb.co/..." class="w-full p-3 rounded-lg dark-bg-input text-white border border-gray-600 focus:ring-accent-color focus:border-accent-color">
        </div>

        <div class="mb-6">
            <label for="github-token" class="block text-white text-lg mb-2">رمز GitHub (Token):</label>
            <input type="password" 
                   id="github-token" 
                   value="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" 
                   placeholder="الصق رمز الوصول الشخصي هنا (مثل ghp_...)" 
                   class="w-full p-3 rounded-lg dark-bg-input text-white border border-gray-600 focus:ring-accent-color focus:border-accent-color">
            <p class="text-xs text-red-400 mt-2">
                *الرمز السري جاهز الآن.
            </p>
        </div>
        
        <button onclick="publishNewImage()" class="btn-gold px-8 py-3 text-xl font-bold rounded-xl shadow-xl w-full">
            🚀 نشر الصورة الآن 
        </button>
        
        <p id="publish-status" class="text-center mt-4 text-white h-6 font-bold"></p>

        <div class="mt-8 pt-4 border-t border-gray-700">
            <h4 class="text-xl accent-color mb-3">إعدادات النشر (معدلة لحسابك):</h4>
            <div class="space-y-2 text-sm text-gray-400">
                <p><strong>مالك المستودع (Owner):</strong> <span id="display-owner">Rxwab</span></p>
                <p><strong>اسم المستودع (Repo):</strong> <span id="display-repo">Prince_Haidar</span></p>
                <p><strong>اسم ملف البيانات:</strong> <span>data.json</span></p>
            </div>
        </div>
    </div>

    <script>
        // ** تم تعديل هذه المتغيرات لتناسب حسابك 'Rxwab' والمستودع 'Prince_Haidar' **
        const REPO_OWNER = 'Rxwab';  
        const REPO_NAME = 'Prince_Haidar'; 
        const DATA_FILE_PATH = 'data.json';
        const BRANCH_NAME = 'main'; 

        // لعرض الإعدادات في الواجهة
        document.getElementById('display-owner').textContent = REPO_OWNER;
        document.getElementById('display-repo').textContent = REPO_NAME;

        /**
         * تحويل النص إلى Base64 (مطلوب لـ GitHub API)
         */
        function toBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        /**
         * ينشر الصورة الجديدة عن طريق تعديل ملف data.json على GitHub
         */
        async function publishNewImage() {
            const imageUrl = document.getElementById('image-url').value;
            const token = document.getElementById('github-token').value;
            const statusElement = document.getElementById('publish-status');
            
            statusElement.textContent = 'جاري الاتصال بـ GitHub...';
            statusElement.className = 'text-center mt-4 text-yellow-400 h-6 font-bold';

            if (!imageUrl || !token) {
                statusElement.textContent = 'يرجى إدخال رابط الصورة والرمز السري.';
                statusElement.className = 'text-center mt-4 text-red-500 h-6 font-bold';
                return;
            }

            const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_FILE_PATH}`;

            try {
                // 1. جلب الملف الحالي (للحصول على SHA، وهو ضروري للتعديل)
                let response = await fetch(API_URL, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.com.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`فشل جلب الملف: ${response.status} - ${response.statusText}`);
                }

                const fileData = await response.json();
                const currentContentBase64 = fileData.content;
                const currentSHA = fileData.sha;

                // فك تشفير المحتوى الحالي وإضافة الرابط الجديد
                const currentContentJson = JSON.parse(atob(currentContentBase64));
                currentContentJson.published_images.push(imageUrl); 
                
                // ترميز المحتوى الجديد مرة أخرى إلى Base64
                const newContentString = JSON.stringify(currentContentJson, null, 2);
                const newContentBase64 = toBase64(newContentString);

                // 2. إرسال طلب التعديل (PUT)
                const putBody = JSON.stringify({
                    message: `Added new image via Admin Panel: ${new Date().toISOString()}`,
                    content: newContentBase64,
                    sha: currentSHA, // نرسل SHA القديم لإثبات أننا نعدل نفس الملف
                    branch: BRANCH_NAME
                });

                response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.com.v3+json'
                    },
                    body: putBody
                });

                if (!response.ok) {
                    throw new Error(`فشل النشر: ${response.status} - ${response.statusText}`);
                }

                statusElement.textContent = '✅ تم النشر بنجاح! قد يستغرق ظهور الصورة دقيقة على الموقع.';
                statusElement.className = 'text-center mt-4 text-green-500 h-6 font-bold';
                document.getElementById('image-url').value = ''; 
                // نترك التوكن كما هو لسهولة استخدامه في المرة القادمة

            } catch (error) {
                console.error('GitHub API Error:', error);
                statusElement.textContent = `❌ خطأ في النشر: ${error.message}. تأكد من صحة التوكن والإعدادات.`;
                statusElement.className = 'text-center mt-4 text-red-500 h-6 font-bold';
            }
        }
    </script>
</body>
  </html>
