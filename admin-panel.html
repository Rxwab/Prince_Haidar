<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Haidar | لوحة التحكم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f7f7;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .header-bg {
            background-color: #3b2820; /* بني داكن */
            color: #d4a761; /* ذهبي */
        }
        .btn-primary {
            background-color: #d4a761; 
            color: #3b2820;
            transition: all 0.3s;
            font-weight: bold;
        }
        .btn-primary:hover {
            background-color: #c09450;
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="header-bg p-6 rounded-t-lg mb-8">
            <h1 class="text-3xl font-bold text-center">لوحة تحكم Prince Haidar</h1>
            <p class="text-center text-gray-300 mt-2">إدارة صور المنتجات والعروض النصية</p>
        </header>

        <div id="status-message" class="p-4 text-center rounded-lg mb-6 hidden"></div>
        
        <div class="bg-gray-100 p-6 rounded-lg mb-8 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">إعدادات GitHub</h2>
            <div class="space-y-4">
                <div>
                    <label for="github-token" class="block text-gray-700 font-semibold mb-1">رمز GitHub (Personal Access Token):</label>
                    <input type="password" id="github-token" placeholder="أدخل رمز التوكن هنا" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d4a761]">
                    <p class="text-sm text-gray-500 mt-1">يجب أن يكون للرمز صلاحيات "repo" و "workflow" للعمل.</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="p-6 border border-gray-300 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">1. نشر صورة جديدة (جاتوه أو كعكة)</h2>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">نوع المنتج:</label>
                    <div class="flex space-x-4 space-x-reverse">
                        <label class="inline-flex items-center">
                            <input type="radio" name="product-type" value="daily_pastries" checked class="form-radio text-[#d4a761]">
                            <span class="ml-2 text-gray-700">جاتوه يومي</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="product-type" value="celebration_cakes" class="form-radio text-[#d4a761]">
                            <span class="ml-2 text-gray-700">كعكة مناسبة</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="image-file" class="block text-gray-700 font-semibold mb-1">اختر ملف الصورة (PNG/JPG):</label>
                    <input type="file" id="image-file" accept="image/*" 
                           class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                </div>

                <div class="mb-6">
                    <label for="image-commit-message" class="block text-gray-700 font-semibold mb-1">رسالة الالتزام (Commit Message):</label>
                    <input type="text" id="image-commit-message" value="رفع صورة جديدة"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d4a761]">
                </div>

                <button onclick="uploadImage()" class="btn-primary w-full p-3 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    نشر الصورة
                </button>
            </div>
            
            <div class="p-6 border border-gray-300 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">2. نشر عرض نصي جديد</h2>
                
                <div class="mb-4">
                    <label for="offer-text" class="block text-gray-700 font-semibold mb-1">نص العرض الجديد:</label>
                    <textarea id="offer-text" rows="4" placeholder="اكتب تفاصيل العرض هنا، مثال: خصم 20% على جميع كعكات الشوكولاتة..."
                              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d4a761]"></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="offer-commit-message" class="block text-gray-700 font-semibold mb-1">رسالة الالتزام (Commit Message):</label>
                    <input type="text" id="offer-commit-message" value="إضافة عرض نصي جديد"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#d4a761]">
                </div>

                <button onclick="publishTextOffer()" class="btn-primary w-full p-3 rounded-lg flex items-center justify-center">
                     <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    نشر العرض النصي
                </button>
            </div>
        </div>
        
        <hr class="my-10 border-gray-300">

        <div class="p-6 border border-red-300 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 text-red-600">3. إدارة (حذف) العروض النصية الحالية</h2>
            <div id="offers-list-container" class="space-y-4">
                 <p class="text-gray-500 text-center">جاري تحميل العروض الحالية...</p>
            </div>
             <div class="mt-4 text-center">
                <button onclick="loadCurrentOffers()" class="bg-gray-500 text-white font-semibold p-2 rounded-lg hover:bg-gray-600">
                    تحديث القائمة
                </button>
            </div>
        </div>


    </div>

    <script>
        // **********************************
        // ******* CONFIGURATION ************
        // **********************************
        const REPO_OWNER = 'YOUR_GITHUB_USERNAME'; // غيّر هذا إلى اسم مستخدم GitHub الخاص بك
        const REPO_NAME = 'YOUR_REPO_NAME';       // غيّر هذا إلى اسم المستودع (Repo) الخاص بك
        const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents`;
        const DATA_FILE_PATH = 'data.json';
        const IMAGE_FOLDER_PATH = 'assets/images';

        // **********************************
        // ********* HELPER FUNCTIONS *********
        // **********************************

        /**
         * FIX: Function to safely encode Arabic (UTF-8) content to Base64.
         * This solves the "contains characters outside of the Latin1 range" error.
         * @param {string} str - The UTF-8 string (e.g., JSON string with Arabic text).
         * @returns {string} Base64 encoded string.
         */
        function utf8ToBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }
        
        // Function to decode Base64 to a readable UTF-8 string
        function base64ToUtf8(str) {
             return decodeURIComponent(escape(atob(str)));
        }


        // Display status message
        function displayStatus(message, isError = false) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');
            if (isError) {
                statusElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusElement.classList.add('bg-green-100', 'text-green-700');
            }
            // إخفاء الرسالة بعد 8 ثوان
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 8000); 
        }

        // Get GitHub headers
        function getHeaders() {
            const token = document.getElementById('github-token').value;
            if (!token) {
                displayStatus('خطأ: يرجى إدخال رمز GitHub التوكن أولاً.', true);
                return null;
            }
            return {
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            };
        }

        // **********************************
        // ********* CORE API FUNCTIONS *********
        // **********************************

        /**
         * Get the current content and SHA of a file.
         * @param {string} filePath - Path to the file (e.g., 'data.json').
         * @returns {Promise<{content: string, sha: string} | null>} 
         */
        async function getFileContent(filePath) {
            const headers = getHeaders();
            if (!headers) return null;

            try {
                const response = await fetch(`${API_URL}/${filePath}`, { headers });
                if (response.status === 404) {
                     displayStatus(`تحذير: الملف ${filePath} غير موجود. سيتم إنشاؤه.`, false);
                    return { content: null, sha: null };
                }
                if (!response.ok) {
                    throw new Error(`Failed to fetch file: ${response.statusText}`);
                }
                const data = await response.json();
                
                // Decode content using the safe function for Arabic characters
                const utf8Content = base64ToUtf8(data.content); 

                return {
                    content: utf8Content,
                    sha: data.sha
                };
            } catch (error) {
                console.error('GitHub API Error:', error);
                displayStatus(`❌ خطأ في جلب الملف: ${error.message}. تأكد من إعدادات GitHub والتوكن.`, true);
                return null;
            }
        }

        /**
         * Publish (Update or Create) a file on GitHub.
         * @param {string} filePath - Path to the file.
         * @param {string} content - The file content (Base64 for images, raw string for JSON/text).
         * @param {string} commitMessage - The commit message.
         * @param {string | null} sha - The current SHA of the file (required for update).
         * @param {boolean} isImage - If true, content is already Base64 and SHA is not needed for new file.
         * @returns {Promise<boolean>} Success status.
         */
        async function publishContent(filePath, content, commitMessage, sha = null, isImage = false) {
            const headers = getHeaders();
            if (!headers) return false;

            let contentBase64;
            
            if (isImage) {
                // Images are already Base64 data URLs, we extract the Base64 part
                contentBase64 = content.split(',')[1];
            } else {
                // Apply the FIX: Encode the UTF-8 string (JSON with Arabic) to Base64 safely
                contentBase64 = utf8ToBase64(content); 
            }

            const body = {
                message: commitMessage,
                content: contentBase64,
                sha: sha 
            };
            
            if (!sha && !isImage) {
                // If sha is null, it's a new file (create), SHA field is omitted.
                delete body.sha;
            }
            
            try {
                const response = await fetch(`${API_URL}/${filePath}`, {
                    method: sha ? 'PUT' : 'PUT', // Always PUT for update/create
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || response.statusText);
                }
                
                // Get the updated SHA for subsequent calls if needed
                const updatedData = await response.json();
                return { success: true, sha: updatedData.content.sha };

            } catch (error) {
                console.error('GitHub API Error:', error);
                displayStatus(`❌ خطأ في النشر: ${error.message}. قد تحتاج لتحديث التوكن أو مراجعة الرسالة.`, true);
                return { success: false, sha: null };
            }
        }

        // **********************************
        // ***** IMAGE PUBLISHING LOGIC *****
        // **********************************

        async function uploadImage() {
            const fileInput = document.getElementById('image-file');
            const file = fileInput.files[0];
            const productType = document.querySelector('input[name="product-type"]:checked').value;
            const commitMessage = document.getElementById('image-commit-message').value;

            if (!file) {
                displayStatus('خطأ: يرجى اختيار ملف صورة أولاً.', true);
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                displayStatus('خطأ: حجم الملف كبير جداً. يجب أن يكون أقل من 5 ميغابايت.', true);
                return;
            }

            displayStatus('جاري معالجة الصورة...', false);

            const reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onload = async () => {
                const base64Data = reader.result;
                const fileExtension = file.name.split('.').pop();
                // اسم فريد للصورة
                const newImageFileName = `${productType}-${Date.now()}.${fileExtension}`; 
                const imagePath = `${IMAGE_FOLDER_PATH}/${newImageFileName}`;
                
                try {
                    // 1. نشر الصورة نفسها كملف منفصل
                    const publishImageResult = await publishContent(imagePath, base64Data, commitMessage, null, true);
                    if (!publishImageResult.success) return; 

                    // 2. تحديث ملف data.json
                    displayStatus('جاري تحديث ملف data.json بإضافة رابط الصورة...', false);
                    const fileData = await getFileContent(DATA_FILE_PATH);
                    
                    let jsonContent;
                    if (fileData.content) {
                        jsonContent = JSON.parse(fileData.content);
                    } else {
                        // إنشاء ملف JSON جديد إذا لم يكن موجوداً
                        jsonContent = { daily_pastries: [], celebration_cakes: [], special_offers: [] };
                    }

                    // إضافة رابط الصورة (المسار الكامل في GitHub)
                    const rawUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${imagePath}`;
                    jsonContent[productType].unshift(rawUrl); 

                    const updatedContent = JSON.stringify(jsonContent, null, 4);
                    
                    const updateJsonResult = await publishContent(DATA_FILE_PATH, updatedContent, `Add ${productType} image: ${newImageFileName}`, fileData.sha);
                    
                    if (updateJsonResult.success) {
                        displayStatus(`✅ تم نشر الصورة بنجاح وتحديث data.json! الرابط: ${rawUrl}`, false);
                    } else {
                        displayStatus('❌ خطأ في تحديث ملف data.json.', true);
                    }

                } catch (error) {
                    displayStatus(`❌ خطأ أثناء النشر: ${error.message}`, true);
                }
            };

            reader.onerror = () => {
                displayStatus('خطأ في قراءة ملف الصورة.', true);
            };
        }
        
        // **********************************
        // **** TEXT OFFER LOGIC (CRUD) *****
        // **********************************
        
        // --- 2. نشر عرض نصي جديد ---
        async function publishTextOffer() {
            const offerText = document.getElementById('offer-text').value.trim();
            const commitMessage = document.getElementById('offer-commit-message').value.trim() || "إضافة عرض نصي";

            if (!offerText) {
                displayStatus('خطأ: يرجى كتابة نص العرض أولاً.', true);
                return;
            }

            displayStatus('جاري جلب ملف data.json وتحديثه...', false);
            
            try {
                const fileData = await getFileContent(DATA_FILE_PATH);
                if (!fileData) return;

                let jsonContent;
                if (fileData.content) {
                    jsonContent = JSON.parse(fileData.content);
                } else {
                    jsonContent = { daily_pastries: [], celebration_cakes: [], special_offers: [] };
                }

                // إضافة العرض الجديد إلى المصفوفة
                jsonContent.special_offers.unshift(offerText); 
                
                const updatedContent = JSON.stringify(jsonContent, null, 4);
                
                const updateJsonResult = await publishContent(DATA_FILE_PATH, updatedContent, commitMessage, fileData.sha);
                
                if (updateJsonResult.success) {
                    displayStatus('✅ تم نشر العرض النصي بنجاح وتحديث data.json!', false);
                    document.getElementById('offer-text').value = ''; // مسح الحقل
                    loadCurrentOffers(); // تحديث قائمة الحذف
                } else {
                    displayStatus('❌ خطأ في تحديث ملف data.json.', true);
                }

            } catch (error) {
                displayStatus(`❌ خطأ في معالجة JSON: ${error.message}.`, true);
            }
        }
        
        // --- 3. حذف عرض نصي ---
        async function deleteTextOffer(index) {
            const commitMessage = `حذف العرض النصي رقم ${index + 1}`;
            
            if (!confirm(`هل أنت متأكد من حذف العرض رقم ${index + 1}؟`)) return;

            displayStatus('جاري جلب ملف data.json وحذف العرض...', false);
            
            try {
                const fileData = await getFileContent(DATA_FILE_PATH);
                if (!fileData) return;

                let jsonContent = JSON.parse(fileData.content);
                
                // التأكد من أن special_offers مصفوفة وغير فارغة
                if (!Array.isArray(jsonContent.special_offers) || jsonContent.special_offers.length <= index) {
                    displayStatus('خطأ: لا يمكن العثور على العرض المطلوب حذفه.', true);
                    return;
                }
                
                // إزالة العرض من المصفوفة
                jsonContent.special_offers.splice(index, 1); 
                
                const updatedContent = JSON.stringify(jsonContent, null, 4);
                
                const updateJsonResult = await publishContent(DATA_FILE_PATH, updatedContent, commitMessage, fileData.sha);
                
                if (updateJsonResult.success) {
                    displayStatus('✅ تم حذف العرض النصي بنجاح!', false);
                    loadCurrentOffers(); // تحديث قائمة الحذف
                } else {
                    displayStatus('❌ خطأ في حذف العرض من data.json.', true);
                }

            } catch (error) {
                displayStatus(`❌ خطأ في معالجة JSON: ${error.message}.`, true);
            }
        }

        // --- تحميل العروض الحالية لعرضها للحذف ---
        async function loadCurrentOffers() {
            const container = document.getElementById('offers-list-container');
            container.innerHTML = '<p class="text-gray-500 text-center">جاري تحميل العروض...</p>';
            
            const fileData = await getFileContent(DATA_FILE_PATH);
            if (!fileData || !fileData.content) {
                container.innerHTML = '<p class="text-gray-500 text-center">لا توجد عروض نصية منشورة حاليًا.</p>';
                return;
            }

            try {
                const jsonContent = JSON.parse(fileData.content);
                const offers = Array.isArray(jsonContent.special_offers) ? jsonContent.special_offers : [];

                if (offers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">لا توجد عروض نصية منشورة حاليًا.</p>';
                    return;
                }

                container.innerHTML = ''; // مسح رسالة "جاري التحميل"
                offers.forEach((offer, index) => {
                    // إنشاء عنصر لكل عرض مع زر الحذف
                    const offerElement = document.createElement('div');
                    offerElement.className = 'flex items-center justify-between p-3 border border-red-200 bg-red-50 rounded-lg';
                    offerElement.innerHTML = `
                        <p class="text-gray-700 font-semibold flex-grow">${index + 1}. ${offer}</p>
                        <button onclick="deleteTextOffer(${index})" 
                                class="bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-lg hover:bg-red-600 transition duration-200 flex items-center flex-shrink-0 ml-4">
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            حذف العرض 🗑️
                        </button>
                    `;
                    container.appendChild(offerElement);
                });

            } catch (error) {
                 container.innerHTML = `<p class="text-red-500 text-center">خطأ في تحليل ملف data.json: ${error.message}</p>`;
            }
        }


        // **********************************
        // ******* INITIALIZATION ***********
        // **********************************
        document.addEventListener('DOMContentLoaded', () => {
             // تحميل قائمة العروض عند فتح الصفحة
             loadCurrentOffers();
        });
    </script>
</body>
</html>
